## Проект: Автоматизация ML-пайплайна для предсказания категории цены автомобиля с использованием Apache Airflow
**ML Pipeline Automation with Apache Airflow: Model Training, Selection and Batch Prediction**

---
### Цель проекта
- Разработать автоматизированный пайплайн машинного обучения для классификации автомобилей по ценовой категории.
- Реализовать два основных компонента:
  1. **Обучение и выбор лучшей модели** на исторических данных с сохранением артефакта.
  2. **Пакетное предсказание** для новых объектов с сохранением результатов в CSV.
- Интегрировать оба этапа в **DAG Apache Airflow**, обеспечивающий ежедневный пересчёт модели и получение прогнозов.
- Обеспечить воспроизводимость, логирование и корректную обработку путей при работе в среде Airflow и локально.

### Данные
- **Обучающий набор**: файл `homework.csv` (путь `data/train/homework.csv`), содержащий признаки автомобилей и целевую переменную `price_category` (категория цены).
- **Тестовые объекты**: набор JSON-файлов в папке `data/test/`, каждый файл соответствует одному автомобилю и содержит те же признаки (кроме целевой переменной).
- Предсказания сохраняются в папку `data/predictions/` в формате CSV с именем, содержащим временную метку.

---

## Этапы работы

### 1. Подготовка структуры проекта
Проект организован следующим образом:
```
airflow_hw/
├── dags/
│ └── hw_dag.py          # DAG для Airflow
├── modules/
│ ├── pipeline.py        # Обучение модели
│ └── predict.py         # Предсказание на новых данных
├── data/
│ ├── train/
│ │ └── homework.csv     # Обучающие данные
│ ├── test/              # JSON-файлы с новыми объектами
│ └── predictions/       # Сохранённые предсказания (пустая)
├── models/              # Сохранённые модели (пустая)
└── .gitignore           # Игнорирование данных и моделей
```

### 2. Реализация обучения модели (`pipeline.py`)

**Основные шаги:**
- Загрузка обучающего датасета `homework.csv`.
- Разделение на признаки `X` и целевую переменную `y` (`price_category`).
- Создание пайплайна предобработки данных, включающего:
  - **`filter_data`**: удаление неинформативных колонок (`id`, `url`, `region`, `price`, `image_url`, `description`, `posting_date`, координаты и др.).
  - **`remove_outliers`**: обработка выбросов в признаке `year` методом межквартильного размаха (IQR) – значения за границами заменяются на ближайшую границу.
  - **`create_features`**: генерация новых признаков:
    - `short_model` – первое слово из названия модели (в нижнем регистре).
    - `age_category` – категория возраста автомобиля: `'new'` (>2013), `'old'` (<2006), `'average'` (остальные).
  - **`ColumnTransformer`**:
    - Числовые признаки: заполнение пропусков медианой, стандартизация.
    - Категориальные признаки: заполнение пропусков наиболее частым значением, one-hot кодирование.
- Перебор трёх моделей классификации: `LogisticRegression`, `RandomForestClassifier`, `SVC`.
- Для каждой модели выполняется кросс-валидация (4 фолда) с метрикой `accuracy`. Выбирается модель с наибольшим средним значением accuracy.
- Лучшая модель обучается на всех данных и сохраняется с помощью библиотеки `dill` в папку `models/`. Имя файла содержит дату и время обучения (`cars_pipe_YYYYMMDDHHMM.pkl`).
- Логирование промежуточных результатов (качество каждой модели, имя сохранённого файла) осуществляется через модуль `logging`.

### 3. Реализация предсказания (`predict.py`)

**Основные шаги:**
- Определение функции `get_last_file_name(path)`, которая возвращает имя файла с максимальным значением по алфавиту (т.е. самый новый, если имена содержат временную метку).
- Функция `load_model_last()` загружает модель из последнего `.pkl` файла в папке `models/`.
- Функция `get_list_cars()` формирует список путей ко всем JSON-файлам в папке `data/test/`.
- Функция `calc_pred(model, list_data)` для каждого JSON:
  - загружает данные,
  - преобразует в DataFrame,
  - получает предсказание от модели,
  - выводит в консоль информацию (`id`, `pred`, `price`) и накапливает результат в списке словарей.
- Функция `save_to_file(result)` сохраняет результаты в CSV-файл в папку `data/predictions/` с именем `car_predictions_YYYYMMDDHHMM.csv`.
- Основная функция `predict()` последовательно вызывает все перечисленные шаги.

### 4. Создание DAG в Airflow (`hw_dag.py`)

- DAG с идентификатором `car_price_prediction`.
- Параметры:
  - Владелец: `airflow`.
  - Дата начала: `2022-06-10`.
  - Расписание: `00 15 * * *` (ежедневно в 15:00).
  - Количество попыток при ошибке: 1 с задержкой 1 минута.
- Два **PythonOperator**:
  - `pipeline` – вызывает функцию `pipeline` из модуля `modules.pipeline`.
  - `predict` – вызывает функцию `predict` из модуля `modules.predict`.
- Порядок выполнения: `start_task` (bash-оператор для отладки) → `pipeline` → `predict`.
- Корректная настройка путей: путь к проекту передаётся через переменную окружения `PROJECT_PATH`, что обеспечивает работу как в локальном режиме, так и внутри Airflow.

### 5. Тестирование и запуск

- **Локальный запуск**:
  - Обучение: `python3 modules/pipeline.py`
  - Предсказание: `python3 modules/predict.py`
- **Запуск в Airflow**:
  - Копирование файла `hw_dag.py` в папку `$AIRFLOW_HOME/dags`.
  - После запуска веб-сервера и scheduler'а DAG появляется в интерфейсе.
  - Ручной или автоматический запуск приводит к выполнению обоих шагов и появлению CSV-файла с предсказаниями в `data/predictions/`.

---

## Результаты

### Лучшая модель
В результате кросс-валидации среди трёх кандидатов была выбрана модель **RandomForestClassifier** со средней точностью **0.7388** (значение может незначительно варьироваться в зависимости от random_state). Логи обучения:


    model: LogisticRegression, acc_mean: 0.7290, acc_std: 0.0005
    model: RandomForestClassifier, acc_mean: 0.7388, acc_std: 0.0017
    model: SVC, acc_mean: 0.7375, acc_std: 0.0025
    best model: RandomForestClassifier, accuracy: 0.7388

    
Модель сохранена в файл `cars_pipe_202505190558.pkl` (пример).

### Результаты предсказания
Для всех JSON-файлов в папке `data/test/` получены предсказания и сохранены в CSV. Пример содержимого файла предсказаний:

    id,pred,price
    108939331,1,11995
    108938252,0,5995
    108937926,0,5990
    108937766,2,10900


- `id` – идентификатор объявления.
- `pred` – предсказанная категория цены (0, 1, 2).
- `price` – исходная цена автомобиля (для контроля).

Скриншоты успешного выполнения DAG и содержимого файла с предсказаниями приложены.

---

## Основные выводы

1. **Цель достигнута**: разработан полностью автоматизированный ML-пайплайн, включающий этапы обучения, выбора модели и пакетного предсказания, оркестрируемый Apache Airflow.
2. **Ключевые особенности реализации**:
   - Модульная структура кода с разделением на смысловые функции.
   - Использование переменной окружения `PROJECT_PATH` для корректной работы как в локальной среде, так и внутри Airflow.
   - Логирование вместо `print` для совместимости с системой логирования Airflow.
   - Автоматический выбор самого свежего файла модели для предсказания (через лексикографический максимум).
   - Сохранение результатов с временной меткой во избежание перезаписи.
3. **Применимость**: полученный пайплайн может быть легко адаптирован для других задач классификации или регрессии, достаточно изменить функции предобработки и модели.

---

## Структура репозитория (кратко)

- `dags/hw_dag.py` – DAG для Airflow.
- `modules/pipeline.py` – обучение и сохранение модели.
- `modules/predict.py` – загрузка модели и предсказание.
- `data/` – директория с данными (не выгружается в репозиторий, добавлена в `.gitignore`).
- `models/` – директория для сохранённых моделей (игнорируется git).
- `data/predictions/` – директория для CSV-файлов с предсказаниями (игнорируется git).
- `Screenshots_working_service.pdf` – подтверждение работы DAG и содержимого предсказаний.

---

## Заключение
Проект демонстрирует успешное применение Apache Airflow для автоматизации процессов машинного обучения, обеспечивая воспроизводимость, масштабируемость и удобство мониторинга. Все требования задания выполнены, код готов к использованию в продуктивной среде.